define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","spectrum_comments/comment_stream","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/legacy_annotations_bridge","modules/clean/react/comments2/util","modules/clean/react/comments2/util","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/actions","modules/clean/react/comments2/data/mentions_api","modules/clean/react/file_viewer/coach_mark","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_action_button","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/previews/constants","spectrum_comments/comment/time_coded_comment","spectrum_comments/comment/numbered_comment","spectrum_comments/comment_editor/editor_with_coach_mark","modules/clean/react/comments2/video_annotations/constants","modules/clean/react/comments2/video_annotations/video_preview_event_emitter","modules/core/i18n","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/data/frame_message_listener"],function(e,t,o,n,i,r,s,a,c,m,d,p,u,l,h,v,g,b,_,f,w,y,C,T,E,M,O,A){"use strict";function P(e){var t=e.previewType,o=e.onCoachMarkClose;return t&&[f.PreviewType.Audio,f.PreviewType.Video].includes(t)?n.default.createElement(v.CoachMark,{title:M._("Target your feedback"),arrowPosition:"top-right",showClose:!0,onCloseButtonClick:o},M._("Adding time codes to comments keeps feedback simple, organized, and all in one place.")):n.default.createElement(v.CoachMark,{title:M._("Want to comment?"),arrowPosition:"top-right",showClose:!0,onCloseButtonClick:o},M._("@mention someone to work together on this file"))}function S(e,t){return void 0===t&&(t=1),e===f.PreviewType.Doc?{type:"document",regionType:"rectangle",regions:[{page:t,x:0,y:0,width:1,height:1}]}:{type:"image",region:{page:t,x:0,y:0,width:1,height:1}}}function k(e){var t=e.currentPageNumber,i=e.playerCurrentTime,r=void 0===i?0:i,s=e.pendingNumberedAnnotation,a=e.previewType,c=e.showOnboarding,m=e.onCoachMarkClose,d=c?n.default.createElement(P,{previewType:a,onCoachMarkClose:m}):void 0;if(a===f.PreviewType.Audio)return n.default.createElement(C.TimeCodedCommentEditorWithCoachMark,o.__assign({},e,{pendingAnnotation:{type:"audio",time:r},coachMark:d}));if(a===f.PreviewType.Video)return n.default.createElement(C.TimeCodedCommentEditorWithCoachMark,o.__assign({},e,{pendingAnnotation:{type:"video",time:r},coachMark:d}));if(a===f.PreviewType.Doc||a===f.PreviewType.Photo){var p=s||S(a,t);return n.default.createElement(C.NumberedCommentEditorWithCoachMark,o.__assign({},e,{pendingAnnotation:p,coachMark:d}))}return n.default.createElement(C.CommentEditorWithCoachMark,o.__assign({},e,{coachMark:d}))}Object.defineProperty(t,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),u=o.__importStar(u);var N=(function(e){function t(t){var i=e.call(this,t)||this;i.onCommentStreamRef=function(e){return i.commentStream=e},i.updateMentionsMatches=function(e){i.setState({mentionsMatches:e})},i.onMentionsQueryUpdated=function(e){e?i.mentionsApi.query(e,i.updateMentionsMatches):""===e&&i.updateMentionsMatches(i.mentionsApi.getMatchesWithStarterSuggestions())},i.videoPreviewOnboardingDismissed=function(){i.props.dispatch(l.Actions.suppressOnboardingForSession("video_first_paused"))},i.toggleShowResolved=function(){var e=i.props,t=e.dispatch,o=e.showResolved,n=o?"hide_resolved_threads":"show_resolved_threads";t(l.Actions.toggleShowResolved()),t(l.Actions.logEvent(n))},i.setCommentsEnabled=function(){i.props.dispatch(l.Actions.enableCommenting())},i.setCommentsDisabled=function(){i.props.dispatch(l.Actions.disableCommenting())},i.createEditor=function(e){var t=i.props,r=t.currentPageNumber,s=t.playerCurrentTime,a=t.pendingNumberedAnnotation,c=t.showOnboarding,m=t.stream.previewType;return n.default.createElement(k,o.__assign({},e,{pendingNumberedAnnotation:a,currentPageNumber:r,playerCurrentTime:s,previewType:m,showOnboarding:c,onCoachMarkClose:i.onCoachMarkClose}))},i.onCoachMarkClose=function(){var e=i.props.stream.previewType;e===f.PreviewType.Audio||e===f.PreviewType.Video?i.props.dispatch(l.Actions.suppressOnboardingForSession("initial_video_land")):e!==f.PreviewType.Doc&&e!==f.PreviewType.Photo&&i.props.dispatch(l.Actions.suppressOnboardingForSession("initial_non_annotation_land")),d.markBrowserHasDismissedOnboardingPopup(i.props.stream)};var r=t.dispatch,s=t.viewer;return i.mentionsApi=h.mentionsApi(s),i.frameMessageListener=new A.FrameMessageListener(r),i.state={mentionsMatches:i.mentionsApi.cache},i}return o.__extends(t,e),t.prototype.buildResolveOption=function(){var e=this.props.showResolved?b.FileActionButtonType.HIDE_RESOLVED_COMMENTS:b.FileActionButtonType.SHOW_RESOLVED_COMMENTS;return new _.MoreOption({className:"comments-options-item__show-resolved",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:this.toggleShowResolved})},t.prototype.buildEnableOption=function(){var e,t;return this.props.isEnabled?(e=b.FileActionButtonType.DISABLE_COMMENTS,t=this.setCommentsDisabled):(e=b.FileActionButtonType.ENABLE_COMMENTS,t=this.setCommentsEnabled),new _.MoreOption({className:"comments-options-item__disable",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.buildSubscribeOption=function(){var e,t,o=this;return this.props.isSubscribed?(e=b.FileActionButtonType.UNSUBSCRIBE,t=function(){return o.props.dispatch(l.Actions.unsubscribe(void 0))}):(e=b.FileActionButtonType.SUBSCRIBE,t=function(){return o.props.dispatch(l.Actions.subscribe(void 0))}),new _.MoreOption({className:"comments-options-item__subscribe",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.updateCommentsMoreOptionGroup=function(){var e=[];this.props.canEnable&&e.push(this.buildEnableOption()),e.push(this.buildResolveOption()),this.props.canSubscribe&&e.push(this.buildSubscribeOption());var t=new _.MoreOptionGroup({fileActionButtonGroup:b.FileActionButtonGroup.COMMENTS,options:e});void 0===this.moreOptionGroup?g.moreOptionRegistry.addOption(t):g.moreOptionRegistry.replaceOption(this.moreOptionGroup,t),this.moreOptionGroup=t},t.prototype.componentDidMount=function(){this.updateCommentsMoreOptionGroup(),E.videoPreviewEventEmitter.addListener(T.EventTypes.ONBOARDING_DISMISSED,this.videoPreviewOnboardingDismissed);var e=this.props,t=e.dispatch,o=e.showOnboarding;t(l.Actions.logEvent("show_comments"));var n=d.hasBrowserDismissedOnboardingPopup(this.props.stream)&&Math.random()<.8;t(l.Actions.setSoftHideCommentsPaneOnboarding(n)),o&&!n&&t(l.Actions.logEvent("sidebar_onboarding_shown"))},t.prototype.componentDidUpdate=function(e){var t=this.props,o=t.showOnboarding,n=t.dispatch;this.updateCommentsMoreOptionGroup(),!e.showOnboarding&&o&&n(l.Actions.logEvent("sidebar_onboarding_shown")),!e.requestEditorFocus&&this.props.requestEditorFocus&&(this.commentStream.focusPrimaryEditor(),n(l.Actions.fulfillEditorFocusRequest()))},t.prototype.componentWillUnmount=function(){this.moreOptionGroup&&g.moreOptionRegistry.removeOption(this.moreOptionGroup),E.videoPreviewEventEmitter.removeListener(T.EventTypes.ONBOARDING_DISMISSED,this.videoPreviewOnboardingDismissed)},Object.defineProperty(t.prototype,"actionsAdapter",{get:function(){var e=this.props,t=e.dispatch,o=e.onboardingKeysToMark,n=e.stream,i=e.viewer,r=e.pendingNumberedAnnotation;return a.createActionsAdapter(t,n,o,this.onMentionsQueryUpdated,this.frameMessageListener,i,r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"commentComponent",{get:function(){switch(this.props.stream.previewType){case f.PreviewType.Video:case f.PreviewType.Audio:return w.TimeCodedComment;case f.PreviewType.Photo:case f.PreviewType.Doc:return y.NumberedComment;default:return}},enumerable:!0,configurable:!0}),t.prototype.render=function(){var e,t=this.props,o=t.showResolved,i=t.isMobile,r=t.stream,a=r.id,d=r.previewType,u=t.viewer,l=t.activeThreadId,h=t.hoverThreadId,v=this.props.threads.filter(function(e){return o||!e.resolved});return u&&(e=p.dbxUserToIUser(u)),n.default.createElement("div",{className:"comments-pane-wrapper"},n.default.createElement(s.CommentStream,{ref:this.onCommentStreamRef,id:a,actionsAdapter:this.actionsAdapter,commentComponent:this.commentComponent,editorComponent:this.createEditor,enabled:!0,isMobile:!!i,mentionsMatches:this.state.mentionsMatches,settings:{canAnnotate:!0,canComment:!0,canRead:!0},userPermissions:{canAnnotate:!0,canComment:!0,canRead:!0},threads:v,user:e,activeThreadID:l,hoverThreadID:h,showUnreadPill:m.canShowUnreadPill(u),localization:O.commentsMasterLocalization}),(d===f.PreviewType.Doc||d===f.PreviewType.Photo)&&n.default.createElement(c.LegacyAnnotationsBridge,{frameMessageListener:this.frameMessageListener,previewType:d}))},t})(n.default.Component);t.CommentsPaneComponent=N;var D=i.connect(function(e){var t=u.getContext(e),o=t.stream,n=t.viewer;return{activeThreadId:u.getActivatedThreadId(e),hoverThreadId:u.getHoverThreadId(e),playerCurrentTime:u.getPlayerCurrentTime(e),onboardingKeysToMark:u.getOnboardingKeysUnmarkedForStream(e,o),showOnboarding:u.getShowOnboardingOnCommentsPane(e),showResolved:u.getShowResolved(e),canEnable:u.getCanEnable(e),isEnabled:u.getIsEnabled(e),canSubscribe:u.getCanSubscribe(e),isSubscribed:u.getIsSubscribed(e),pendingNumberedAnnotation:u.getPendingNumberedAnnotation(e),currentPageNumber:u.getCurrentPageNumber(e),stream:o,threads:u.getThreads(e),viewer:n,requestEditorFocus:u.getIsEditorFocusRequested(e)}})(N);t.CommentsPane=r.requireCssWithComponent(D,["/static/js/spectrum_comments/index.web-vfl5xOx2Q.css","/static/css/comments2-sidebar-vflgutHI9.css","/static/css/comments_annotations-vflRcFwIE.css","/static/css/snackbar-vflLtw9Um.css"])});
//# sourceMappingURL=comments_pane.min.js-vflZxnP9Y.map